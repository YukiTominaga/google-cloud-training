Architecting with Google Compute Engine - Day 1

# Google Cloudの操作

## Cloud SDK

gcloudコマンドのことです。
gcloudコマンドにはある程度規則があります。まずは次のコマンドを説明します。

```
gcloud compute instances list
```

`compute` は `Compute Engine`を示します
`instances` は VMインスタンスを示します
`list` は 一覧することを示します

つまりこのコマンドは、Compute EngineのVMインスタンスの一覧を表示します。

`gcloud` に続くコマンドは次のような規則を持っています。
トレーニング中でgcloudコマンドに触れる機会がいくつかあるので、少しだけこの規則を意識してみてください。

```
gcloud <どのプロダクト> <プロダクトの中のリソース> <操作>
```

## REST API

これをGoogle Cloudのリソース操作の主な手段として直接採用することはありません。
Cloud SDKやterraformはその裏でREST APIを経由してリソースを操作しています。
また、REST APIのドキュメントを読むことで、どのような操作を受け付けるのかを理解することに役立つこともあります。

例: https://cloud.google.com/compute/docs/reference/rest/v1/instances/get

# 仮想ネットワーク (VPC Network)

まずGoogle Cloudを理解するための前提として、そのリソースが「グローバル」なのか、特定の「リージョン」に紐づくのか、特定の「ゾーン」に紐づくのかを意識できるようになることが理解のコツです。

VPC Networkは、グローバルなリソースです。
VPC Networkにはリージョンに対してサブネットワークを作成できます。
つまり、1つのVPC Networkには東京リージョンと大阪リージョンそれぞれにサブネットワークを作成できます。東京リージョンに2つ作ることも可能です。
VPC Networkで重要なことは、1つのVPC Network内のサブネットワーク同士は内部IPアドレスで通信ができます。

## 3種類のネットワークモード

カスタムしか使いません。
「デフォルト」はプロジェクト作成時に自動で作成されている `default` という名前のVPC Networkのことです。
これは初めから全リージョンにサブネットワークが作成されていて、脆弱なファイアウォールルールが作成されています。
最初にこれを削除することからGoogle Cloudのプロジェクトは始まります。

「自動モード」は `default` と同じ設定のVPC Networkを作成することと同義です。

「カスタム」はサブネットワークやファイアウォールルールを手動で作成することを指します。

## IPアドレス

前提として、VMインスタンスに外部IPを割り当てることは多くありません。
それを前提としたアーキテクチャは何かを間違えています。

## Cloud DNS

主に以下の2種類のDNSゾーンを作成できます。

- **パブリックゾーン**
  インターネット上の誰でも名前解決できるDNSレコードを管理します。
  例: example.com のAレコードやMXレコードなど。

- **プライベートゾーン**
  特定のVPC Network内からのみ名前解決できるDNSレコードを管理します。
  これにより、内部システム用の名前解決や、マイクロサービス間通信のためのDNSを安全に運用できます。

### 代表的なユースケース

- 独自ドメインのDNS管理（パブリックゾーン）
- VPC内の内部リソース向けDNS（プライベートゾーン）
- オンプレミスとクラウド間のハイブリッドDNS

### 主要なリソース

- **DNSゾーン**: DNSレコードの集合体。パブリックまたはプライベートのいずれか。
- **DNSレコード**: A, AAAA, CNAME, MX, TXT など、一般的なDNSレコードタイプをサポート。

## ルートとファイアウォールルール

ファイアウォールについて、2つ重要なCIDRを紹介します。

- Application Load Balancer(ALB)の `130.211.0.0/22`, `35.191.0.0/16`
- Identity Aware Proxy(IAP)の `35.235.240.0/20`

Google Cloudでアプリケーションをホスティングする際は、そのほとんどの用途でALBを利用します。
ALBを経由してVMインスタンスに到達するためには、上記のCIDRをファイアウォールで許可する必要があります。
※ Cloud RunなどサーバーレスなワークロードについてはVPC Networkに配置されないので、その限りではありません。

ローカルPCからVMインスタンスにSSHで接続する際、通常は外部IPアドレスがないとそのVMインスタンスに接続できませんが、IAPを活用することで内部IPだけでSSHできます。
このとき、上記のCIDRのプロキシを経由するので、TCP22番の許可ルールが必要です。

これら2種類合計3つのCIDRはファイアウォールの設定で頻出するので、覚える必要はありませんが調べられるようにしましょう。

## Cloud NAT

VMインスタンスに外部IPを付与するケースはほとんどないと説明しましたが、それではインターネットにトラフィックを転送することができません。
Cloud NATは、外部IPのないVMインスタンスに対してインターネットへの出口を提供します。
ただし、GoogleのAPIを利用するだけであれば、インターネットへの出口を作成する必要はありません。
これを、「限定公開のGoogleアクセス」と呼びます。

## Identity Aware Proxy

アプリケーションやSSHによる接続を任意のGoogleアカウントに制限できます。
アプリケーションにおいては、社内の人しか利用できないアプリケーションを公開できる点が非常に便利です。
SSHにおいては、外部IPアドレスが付与されていないVMインスタンスにSSH接続する際に利用します。

# 仮想マシン

## Compute Engine

サーバーレスコンピューティングの発展によって、VMインスタンスが必要になるケースはかなり減ってきましたが、GKEなどからコンピューティングリソースとして活用されています。

## コンピューティングオプション

基本的には最もコストとパフォーマンスに優れる`e2`シリーズを最初の選択肢として考えてください。

### 継続利用割引（Sustained Use Discount）とは

Google CloudのCompute Engineでは、VMインスタンスを1か月のうち長時間（特に25%以上）稼働させると、自動的に「継続利用割引（Sustained Use Discount）」が適用されます。
この割引は、インスタンスの稼働時間が長くなるほど割引率が高くなる仕組みで、最大で約30%の割引が受けられます。

#### 特徴

- **自動適用**
  特別な申請や設定は不要で、対象インスタンスの稼働時間に応じて自動的に割引が適用されます。
- **割引率の段階制**
  1か月のうち稼働時間が25%、50%、75%、100%を超えるごとに割引率が上がります。
- **Spot VMや一部の特殊なVMタイプは対象外**
  通常のオンデマンドVMインスタンスが対象です。

## ディスク

よく使う永続ディスクは以下の3種類です。

### 1. Balanced（バランスド永続ディスク）

- **特徴**: 汎用的な用途向けのSSDベースのディスクです。コストとパフォーマンスのバランスが良く、ほとんどのワークロードに適しています。
- **ユースケース**: Webアプリケーション、データベース、一般的な業務システムなど。
- **メリット**: 高いIOPSとスループットを比較的低コストで提供。

### 2. HDD（標準永続ディスク）

- **特徴**: ハードディスクドライブ（HDD）ベースのディスクで、コスト重視の大容量ストレージ用途に向いています。IOPSやスループットはSSD系より低いです。
- **ユースケース**: バックアップ、アーカイブ、ログ保存など、アクセス頻度が低いデータの保存に最適。
- **メリット**: 大容量を安価に確保できる。

### 3. SSD（高性能永続ディスク）

- **特徴**: 最も高いパフォーマンスを持つSSDベースのディスクです。IOPSやスループットが非常に高く、レイテンシも低いです。
- **ユースケース**: 高負荷なデータベース、トランザクション処理、分析ワークロードなど、ストレージ性能が重要なシステムに最適。
- **メリット**: 最高レベルのパフォーマンスを提供。

> **ポイント**:
>
> - 通常はBalancedを選択し、コストやパフォーマンス要件に応じてHDDやSSDを使い分けるのがベストプラクティスです。

# Identity and Access Management

Google Cloudにおける人やサービスアカウントの権限を制御します。

Google Cloudのリソースは、組織 > フォルダ > プロジェクト > リソース という階層になっていて、この4階層すべてに権限が設定可能で、設定した権限は下の階層に継承されます。
前提として、「最小権限の原則」を意識してください。
なるべく下の階層に対して権限を設定するのが理想ですが、運用コストとのバランスを考慮することが重要です。

## ロール

Google Cloudの権限はそれを直接割り当てることはできません。
ロールは1つ以上の権限を内包するリソースであり、このロールを割り当てます。
Google Cloudには膨大な数の権限と、それらをまとめる事前定義済みのロールもまた大量に存在します。
自分好みの権限だけを含むカスタムロールを作成できますが、管理が大変なので事前定義済みのロールだけで完結させることを推奨します。

Google Cloudに関する作業をしていると、しばしば権限が足りないことを指摘されます。
その際に、どのロールが権限を有しているのかは、[このページ](https://cloud.google.com/iam/docs/roles-permissions)で検索します。

## サービスアカウント

サービスやアプリケーションを主体とするときに、そのサービスに割り当てます。
サービスアカウントには役割を設定できるので、そのサービスが実行できる操作を制御できます。
例えば、Geminiを利用するアプリケーションには、`Vertex AI User`の役割が付与されたサービスアカウントが設定されている必要があります。

デフォルトのCompute Engineサービスアカウントは、強い権限を持ち暗黙的に様々なシーンで利用されてしまうため、可能な限り削除しましょう。

## サービスアカウント鍵ファイル

json形式の鍵ファイルを出力することで、サービスアカウントの役割をGoogle Cloudの外部で利用できます。
しかし、鍵ファイルを作成すること自体が非常にリスクのある行為なので、極力使用しません。
組織ポリシーで鍵ファイルの作成を抑止し、GitHub Actionsでは[Workload Identity Federation](https://cloud.google.com/iam/docs/workload-identity-federation?hl=ja)を利用してサービスアカウントの役割を利用します。
